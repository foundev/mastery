<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mastery — Goal Tracking & Analytics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b1020;           /* deep blue-gray */
        --panel: #121a2e;        /* panel background */
        --border: #2a3553;       /* subtle border */
        --text: #e7ecf5;         /* primary text */
        --muted: #a9b3c9;        /* secondary text */
        --primary: #5b8cff;      /* primary blue */
        --primary-contrast: #08122a;
        --success: #22c55e;      /* green */
        --danger: #ef4444;       /* red */
        --focus: #ffd166;        /* focus accent */
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f7f8fb;
          --panel: #ffffff;
          --border: #e3e7ef;
          --text: #0f172a;
          --muted: #475569;
          --primary: #2563eb;
          --primary-contrast: #ffffff;
          --success: #16a34a;
          --danger: #dc2626;
          --focus: #92400e;
        }
      }
      html, body { height: 100%; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; line-height: 1.5; background: var(--bg); color: var(--text); }
      .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
      header.appbar { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(140%) blur(6px); background: color-mix(in oklab, var(--bg) 85%, transparent); border-bottom: 1px solid var(--border); }
      .appbar-inner { display: flex; align-items: center; justify-content: space-between; gap: 12px; max-width: 1000px; margin: 0 auto; padding: 12px 24px; }
      h1 { margin: 0; font-size: 20px; }
      .subtitle { margin: 6px 0 20px; color: var(--muted); }
      .row { display: flex; gap: 16px; flex-wrap: wrap; }
      .card { border: 1px solid var(--border); border-radius: 12px; padding: 16px; flex: 1 1 340px; background: var(--panel); box-shadow: 0 1px 1px rgba(0,0,0,.04); }
      .muted { color: var(--muted); }
      input, button, select, textarea { font: inherit; color: inherit; }
      input[type="text"], input[type="number"], input[type="date"], textarea { padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; width: 100%; box-sizing: border-box; background: var(--bg); color: var(--text); }
      input:focus, textarea:focus { outline: 3px solid color-mix(in oklab, var(--focus) 40%, transparent); border-color: var(--focus); }
      .btn { padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px; background: var(--panel); color: var(--text); cursor: pointer; transition: background .15s, border-color .15s, transform .05s; display: inline-flex; align-items: center; gap: 6px; }
      .btn:hover { border-color: color-mix(in oklab, var(--border) 60%, var(--text) 40%); }
      .btn:active { transform: translateY(1px); }
      .btn-primary { background: var(--primary); color: var(--primary-contrast); border-color: var(--primary); }
      .btn-secondary { background: color-mix(in oklab, var(--panel) 80%, var(--text) 20%); }
      .btn-outline { background: transparent; }
      .btn-danger { color: #fff; background: var(--danger); border-color: var(--danger); }
      .btn:disabled { opacity: .6; cursor: not-allowed; }
      .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .goal { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start; }
      .goal h3 { margin: 0; font-size: 18px; }
      .goal .meta { font-size: 12px; }
      .progress { height: 12px; background: color-mix(in oklab, var(--panel) 70%, var(--text) 30%); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
      .progress > span { display: block; height: 100%; background: var(--success); width: 0%; transition: width .2s ease; }
      .list { display: grid; gap: 14px; }
      .stack { display: grid; gap: 10px; }
      .spacer { height: 8px; }
      .right { text-align: right; }
      .small { font-size: 12px; }
      .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
      @media (max-width: 640px) { .grid2 { grid-template-columns: 1fr; } }
      .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
      .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
      .controls button .material-symbols-outlined { font-size: 22px; }
      .controls button .label { margin-left: 2px; }
      .controls button { display: inline-flex; align-items: center; }
      .controls button:disabled .material-symbols-outlined { opacity: .9; }
      .startBtn .material-symbols-outlined { color: #fff; }
      .stopBtn .material-symbols-outlined { color: #fff; }
      /* Modal styles */
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity .2s ease; }
      .modal-backdrop[aria-hidden="false"] { opacity: 1; }
      .modal { width: min(640px, 92vw); background: var(--panel); color: inherit; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden; transform: scale(.98) translateY(8px); transition: transform .2s ease; }
      .modal-backdrop[aria-hidden="false"] .modal { transform: none; }
      .modal header, .modal footer { padding: 16px; border-bottom: 1px solid var(--border); }
      .modal footer { border-top: 1px solid var(--border); border-bottom: none; }
      .modal main { padding: 16px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .modal h3 { margin: 0; font-size: 18px; }
      /* Ensure dialog buttons have sufficient contrast */
      .modal footer button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
      .modal footer button .material-symbols-outlined { color: currentColor; }
      .modal footer button.primary, #ag_submit, #atm_submit { background: var(--primary); color: var(--primary-contrast); border-color: var(--primary); }
      .modal footer button.secondary, #ag_cancel, #atm_cancel { background: transparent; color: var(--text); }
      .modal footer button.contrast, #del_confirm { background: var(--danger); color: #ffffff; border-color: var(--danger); }
      .fab { position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: var(--primary-contrast); border: none; cursor: pointer; font-size: 24px; font-weight: bold; box-shadow: 0 6px 16px rgba(0,0,0,.35); transition: transform .15s ease, box-shadow .15s ease; display: flex; align-items: center; justify-content: center; }
      .fab:hover { transform: scale(1.06); box-shadow: 0 6px 16px rgba(0,0,0,.2); }
      /* Focus ring */
      :where(a, button, input, textarea):focus { outline: 3px solid color-mix(in oklab, var(--focus) 50%, transparent); outline-offset: 2px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  </head>
  <body>
    <a href="#content" class="small" style="position:absolute;left:-9999px;top:0;background:var(--focus);color:#000;padding:8px 12px;border-radius:8px;">Skip to content</a>
    <header class="appbar" role="banner">
      <div class="appbar-inner">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="material-symbols-outlined" aria-hidden="true">track_changes</span>
          <h1 style="font-size:18px;margin:0;">Mastery</h1>
        </div>
        <nav aria-label="Top toolbar" style="display:flex;gap:8px;">
          <button id="openAnalyticsBtn" class="btn btn-outline" title="Open Analytics" type="button"><span class="material-symbols-outlined">analytics</span><span class="label">Analytics</span></button>
          <button id="exportBtn" class="btn btn-outline" title="Export Backup" type="button"><span class="material-symbols-outlined">download</span><span class="label">Export</span></button>
          <input id="importInput" type="file" accept="application/json" style="display:none" />
          <button id="importBtn" class="btn btn-outline" title="Import Backup" type="button"><span class="material-symbols-outlined">upload</span><span class="label">Import</span></button>
          <button id="openAddGoalToolbar" class="btn btn-primary" type="button"><span class="material-symbols-outlined">add</span><span class="label">Add Goal</span></button>
        </nav>
      </div>
    </header>
    <main id="content" class="container" role="main">
      <p class="subtitle">Mastery-focused goal tracking with live timers, manual entry, and analytics</p>
      <div class="row">
        <section class="card" style="flex: 1 1 100%;">
          <h2 style="margin:0 0 12px;font-size:18px;">Your Goals</h2>
          <div id="goalsList" class="list"></div>
        </section>
      </div>
    </main>

    <template id="goalItemTmpl">
      <div class="goal">
        <div class="stack">
          <h3></h3>
          <div class="progress" role="progressbar" aria-label="Goal progress"><span></span></div>
          <div class="meta muted small"></div>
          <div class="controls">
            <button class="startBtn primary" title="Start Timer"><span class="material-symbols-outlined">play_arrow</span><span class="label">Start</span></button>
            <button class="stopBtn secondary" title="Stop Timer" disabled><span class="material-symbols-outlined filled">stop</span><span class="label">Stop</span></button>
            <button class="addTimeBtn outline" title="Add Time"><span class="material-symbols-outlined">add</span><span class="label">Add</span></button>
            <button class="progressBtn outline" title="Show Progress"><span class="material-symbols-outlined">query_stats</span><span class="label">Progress</span></button>
            <button class="deleteBtn outline" title="Delete"><span class="material-symbols-outlined">delete</span><span class="label">Delete</span></button>
          </div>
        </div>
        <div class="right muted small liveTimer">00:00:00</div>
      </div>
    </template>

    <!-- Add Goal Modal -->
    <div id="addGoalModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addGoalTitle">
        <header><h3 id="addGoalTitle">Add New Goal</h3></header>
        <main>
          <div class="stack">
            <label class="small muted">Title</label>
            <div style="position:relative;">
              <input id="ag_title" type="text" placeholder="Goal title" autocomplete="off" />
              <div id="ag_suggestions" style="position:absolute; top:100%; left:0; right:0; background:var(--pico-background-color, #fff); border:1px solid rgba(0,0,0,.2); border-radius:8px; display:none; max-height:220px; overflow:auto; z-index: 10;"></div>
            </div>
            <label class="small muted">Description (optional)</label>
            <textarea id="ag_desc" rows="3" placeholder="Describe the goal"></textarea>
            <label class="small muted">Total hours required</label>
            <input id="ag_hours" type="number" min="0.1" step="0.1" placeholder="e.g. 200" />
          </div>
        </main>
        <footer>
          <div class="grid">
            <button id="ag_cancel" class="secondary">Cancel</button>
            <button id="ag_submit" class="primary" disabled>Add Goal</button>
          </div>
        </footer>
      </div>
    </div>

    <!-- Add Time Modal -->
    <div id="addTimeModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addTimeTitle">
        <header><h3 id="addTimeTitle">Add Time</h3></header>
        <main>
          <div id="atm_error" class="small" style="display:none; color:#d32f2f; border:1px solid #f44336; padding:10px; border-radius:8px; background:#ffebee;"></div>
          <div class="stack">
            <label class="small muted">Hours to add</label>
            <input id="atm_hours" type="number" min="0.1" step="0.1" placeholder="e.g. 1.5" />
            <label class="small muted">Date (optional)</label>
            <input id="atm_date" type="date" max="" />
          </div>
        </main>
        <footer>
          <div class="grid">
            <button id="atm_cancel" class="secondary">Cancel</button>
            <button id="atm_submit" class="primary" disabled>Add Time</button>
          </div>
        </footer>
      </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="progressTitle" style="width:min(920px,95vw)">
        <header><h3 id="progressTitle">Progress</h3></header>
        <main>
          <div class="stack">
            <div id="pm_stats" class="small muted"></div>
            <div id="pm_chart" style="width:100%; height:400px;"></div>
          </div>
        </main>
        <footer>
          <button id="pm_close">Close</button>
        </footer>
      </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="analyticsTitle" style="width:min(1000px,96vw)">
        <header><h3 id="analyticsTitle">Analytics</h3></header>
        <main>
          <div class="stack">
            <div class="grid2">
              <div>
                <h4 style="margin:0 0 6px;">Daily Time Trend (All Goals)</h4>
                <div id="an_trend" style="width:100%; height:360px;"></div>
              </div>
              <div>
                <h4 style="margin:0 0 6px;">Time by Goal</h4>
                <div id="an_pie" style="width:100%; height:360px;"></div>
              </div>
            </div>
          </div>
        </main>
        <footer>
          <button id="an_close">Close</button>
        </footer>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
        <header><h3 id="deleteTitle">Delete Goal</h3></header>
        <main>
          <p><strong id="del_question">Are you sure you want to delete this goal?</strong></p>
          <p class="small muted" id="del_warning">This action cannot be undone. All tracked time will be lost.</p>
        </main>
        <footer>
          <div class="grid">
            <button id="del_cancel" class="secondary">Cancel</button>
            <button id="del_confirm" class="contrast">Yes, Delete Goal</button>
          </div>
        </footer>
      </div>
    </div>

    <button id="openAddGoalFab" class="fab" title="Add New Goal" aria-label="Add New Goal"><span class="material-symbols-outlined">add</span></button>

    <script>
      // ---- Storage utilities ----
      const GOALS_KEY = 'goal-tracker-goals';
      const SESSIONS_KEY = 'goal-tracker-sessions';
      const ACTIVE_SESSION_KEY = 'goal-tracker-active-session';

      function loadGoals() {
        try {
          const raw = localStorage.getItem(GOALS_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed.map(g => ({
            id: String(g.id ?? crypto.randomUUID()),
            title: String(g.title ?? 'Untitled'),
            description: String(g.description ?? ''),
            totalHours: Number(g.totalHours ?? 60),
            totalTimeSpent: Number(g.totalTimeSpent ?? 0),
            isActive: Boolean(g.isActive),
            startTime: typeof g.startTime === 'number' ? g.startTime : undefined,
            createdAt: typeof g.createdAt === 'number' ? g.createdAt : Date.now()
          }));
        } catch {
          return [];
        }
      }
      function saveGoals(goals) {
        localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
      }
      function loadSessions() {
        try { const raw = localStorage.getItem(SESSIONS_KEY); return raw ? JSON.parse(raw) : []; } catch { return []; }
      }
      function saveSessions(sessions) { localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions)); }
      function addSession(session) { const s = loadSessions(); s.push(session); saveSessions(s); }
      function saveActiveSession(session) { if (session) localStorage.setItem(ACTIVE_SESSION_KEY, JSON.stringify(session)); else localStorage.removeItem(ACTIVE_SESSION_KEY); }
      function getActiveSession() { try { const s = localStorage.getItem(ACTIVE_SESSION_KEY); return s ? JSON.parse(s) : null; } catch { return null; } }

      // ---- Time helpers ----
      function formatHMS(totalSeconds) {
        const s = Math.max(0, Math.floor(totalSeconds));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const r = s % 60;
        return [h, m, r].map(x => String(x).padStart(2, '0')).join(':');
      }
      function nowMs() { return performance.now ? performance.now() : Date.now(); }
      function formatDuration(ms) {
        const sec = Math.floor(ms / 1000);
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
      }
      function estimateCompletion(goal, sessions) {
        const goalSessions = sessions.filter(s => s.goalId === goal.id);
        if (goalSessions.length < 2) return null;
        const recent = goalSessions
          .slice().sort((a,b) => b.startTime - a.startTime)
          .slice(0, 7);
        const daily = {};
        for (const s of recent) {
          const key = new Date(s.startTime).toDateString();
          const hours = s.duration / 3600000;
          daily[key] = (daily[key] || 0) + hours;
        }
        const vals = Object.values(daily);
        if (vals.length === 0) return null;
        vals.sort((a,b)=>a-b);
        const mid = Math.floor(vals.length/2);
        const median = vals.length % 2 === 0 ? (vals[mid-1]+vals[mid])/2 : vals[mid];
        if (median <= 0) return null;
        const spentHours = goal.totalTimeSpent / 3600000;
        const remaining = goal.totalHours - spentHours;
        if (remaining <= 0) return null;
        const days = Math.ceil(remaining / median);
        const d = new Date(); d.setDate(d.getDate()+days); return d;
      }
      function validateDailyLimit(allSessions, newHours, targetDate) {
        const targetKey = targetDate.toDateString();
        const daily = allSessions.filter(s => new Date(s.startTime).toDateString() === targetKey);
        const current = daily.reduce((t,s)=>t + s.duration/3600000, 0);
        const total = current + newHours;
        if (total > 24) {
          const projectCount = new Set(daily.map(s=>s.goalId)).size;
          const projectText = projectCount > 1 ? `across ${projectCount} projects` : 'for this project';
          return { ok:false, message:`Adding ${newHours} hours would exceed the 24-hour daily limit for ${targetKey}. You already have ${current.toFixed(1)} hours logged ${projectText}.` };
        }
        return { ok:true };
      }

      // ---- App State ----
      let goals = loadGoals();
      let tickHandle = null;
      let addTimeForGoalId = null; // goal targeted by Add Time modal
      let progressForGoalId = null; // goal targeted by Progress modal

      // ---- DOM ----
      const els = {
        goalsList: document.getElementById('goalsList'),
        tmpl: document.getElementById('goalItemTmpl')
      };

      // ---- Rendering ----
      function render() {
        els.goalsList.innerHTML = '';
        const sessions = loadSessions();
        for (const goal of goals) {
          const node = els.tmpl.content.cloneNode(true);
          const root = node.querySelector('.goal');
          const h3 = node.querySelector('h3');
          const progressBar = node.querySelector('.progress > span');
          const meta = node.querySelector('.meta');
          const liveTimer = node.querySelector('.liveTimer');
          const startBtn = node.querySelector('.startBtn');
          const stopBtn = node.querySelector('.stopBtn');
          const addTimeBtn = node.querySelector('.addTimeBtn');
          const progressBtn = node.querySelector('.progressBtn');
          const deleteBtn = node.querySelector('.deleteBtn');

          h3.textContent = goal.title;
          const pct = goal.totalHours > 0 ? Math.min(100, ((goal.totalTimeSpent/3600000) / goal.totalHours) * 100) : 0;
          progressBar.style.width = pct + '%';
          meta.textContent = `${(goal.totalTimeSpent/3600000).toFixed(1)} / ${goal.totalHours} h (${pct.toFixed(0)}%)`;
          liveTimer.textContent = goal.isActive && goal.startTime ? formatHMS((Date.now() - goal.startTime) / 1000) : '00:00:00';

          startBtn.disabled = goal.isActive;
          stopBtn.disabled = !goal.isActive;
          // add visual classes
          startBtn.classList.add('btn','btn-primary','startBtn');
          stopBtn.classList.add('btn','btn-danger','stopBtn');
          addTimeBtn.classList.add('btn','btn-outline','addTimeBtn');
          progressBtn.classList.add('btn','btn-outline','progressBtn');
          deleteBtn.classList.add('btn','btn-outline','deleteBtn');

          startBtn.addEventListener('click', () => startGoal(goal.id));
          stopBtn.addEventListener('click', () => stopGoal());
          addTimeBtn.addEventListener('click', () => openAddTimeModal(goal.id));
          progressBtn.addEventListener('click', () => openProgressModal(goal.id));
          deleteBtn.addEventListener('click', () => openDeleteModal(goal.id, goal.title));

          // ARIA progress semantics
          const pbContainer = node.querySelector('.progress');
          pbContainer.setAttribute('aria-valuemin','0');
          pbContainer.setAttribute('aria-valuemax', String(Math.max(1, goal.totalHours)));
          pbContainer.setAttribute('aria-valuenow', String((goal.totalTimeSpent/3600000).toFixed(1)));
          els.goalsList.appendChild(node);
        }

        ensureTicker();
      }

      function ensureTicker() {
        const anyRunning = goals.some(g => g.isActive);
        if (anyRunning && !tickHandle) {
          tickHandle = setInterval(() => updateLiveTimers(), 1000);
        } else if (!anyRunning && tickHandle) {
          clearInterval(tickHandle);
          tickHandle = null;
        }
      }

      function updateLiveTimers() {
        const goalNodes = els.goalsList.querySelectorAll('.goal');
        goals.forEach((g, idx) => {
          if (!g.isActive || !g.startTime) return;
          const live = goalNodes[idx].querySelector('.liveTimer');
          live.textContent = formatHMS((Date.now() - g.startTime) / 1000);
        });
      }

      // ---- Actions ----
      function addGoal(title, totalHours, description) {
        const goal = {
          id: crypto.randomUUID(),
          title,
          description: description || '',
          totalHours,
          totalTimeSpent: 0,
          isActive: false,
          startTime: undefined,
          createdAt: Date.now()
        };
        goals.push(goal);
        saveGoals(goals);
        render();
      }

      function deleteGoal(id) {
        const g = goals.find(g => g.id === id);
        if (!g) return;
        if (g.isActive) stopGoal();
        goals = goals.filter(g => g.id !== id);
        saveGoals(goals);
        render();
      }

      function startGoal(id) {
        // stop other running goal
        for (const other of goals) { if (other.isActive) stopGoal(); }
        const g = goals.find(g => g.id === id);
        if (!g || g.isActive) return;
        g.isActive = true;
        g.startTime = Date.now();
        saveGoals(goals);
        // persist active session
        saveActiveSession({ goalId: g.id, startTime: g.startTime, lastUpdated: Date.now() });
        render();
      }

      function stopGoal() {
        const now = Date.now();
        let changed = false;
        goals = goals.map(goal => {
          if (goal.isActive && goal.startTime) {
            const sessionDuration = now - goal.startTime;
            addSession({ goalId: goal.id, startTime: goal.startTime, endTime: now, duration: sessionDuration });
            changed = true;
            return { ...goal, isActive: false, totalTimeSpent: goal.totalTimeSpent + sessionDuration, startTime: undefined };
          }
          return goal;
        });
        if (changed) { saveGoals(goals); }
        saveActiveSession(null);
        render();
      }

      function addManualTime(id, minutes) {
        const g = goals.find(g => g.id === id);
        if (!g) return;
        const duration = Math.round(minutes) * 60000;
        const end = Date.now();
        addSession({ goalId: id, startTime: end - duration, endTime: end, duration });
        g.totalTimeSpent = Math.max(0, g.totalTimeSpent + duration);
        saveGoals(goals);
        render();
      }

      // ---- Wire up Add Goal ----
      // No inline add-goal form; use FAB/modal

      // ---- Modal helpers ----
      const addGoalModal = document.getElementById('addGoalModal');
      const addTimeModal = document.getElementById('addTimeModal');
      const progressModal = document.getElementById('progressModal');
      const deleteModal = document.getElementById('deleteModal');
      const analyticsModal = document.getElementById('analyticsModal');
      const fab = document.getElementById('openAddGoalFab');
      fab.addEventListener('click', () => openAddGoalModal());
      const openAddGoalToolbar = document.getElementById('openAddGoalToolbar');
      if (openAddGoalToolbar) openAddGoalToolbar.addEventListener('click', () => openAddGoalModal());
      const openAnalyticsBtn = document.getElementById('openAnalyticsBtn');
      openAnalyticsBtn.addEventListener('click', () => openAnalytics());
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const importInput = document.getElementById('importInput');
      if (exportBtn) exportBtn.addEventListener('click', () => exportBackup());
      if (importBtn) importBtn.addEventListener('click', () => importInput && importInput.click());
      if (importInput) importInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          importBackup(text);
        } catch (err) {
          alert('Failed to read backup file.');
        } finally {
          importInput.value = '';
        }
      });

      function showModal(backdrop) { backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden','false'); }
      function hideModal(backdrop) { backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden','true'); }

      // Add Goal Modal with suggestions
      const templates = [
        // Category I (1200 hours)
        { id:'lang-afrikaans', title:'Learn Afrikaans', description:'Achieve conversational fluency in Afrikaans', hours:1200, category:'Language', keywords:['afrikaans','language','learn','speak','fluent'] },
        { id:'lang-danish', title:'Learn Danish', description:'Achieve conversational fluency in Danish', hours:1200, category:'Language', keywords:['danish','language','learn','speak','fluent'] },
        { id:'lang-dutch', title:'Learn Dutch', description:'Achieve conversational fluency in Dutch', hours:1200, category:'Language', keywords:['dutch','language','learn','speak','fluent'] },
        { id:'lang-french', title:'Learn French', description:'Achieve conversational fluency in French', hours:1200, category:'Language', keywords:['french','language','learn','speak','fluent'] },
        { id:'lang-italian', title:'Learn Italian', description:'Achieve conversational fluency in Italian', hours:1200, category:'Language', keywords:['italian','language','learn','speak','fluent'] },
        { id:'lang-norwegian', title:'Learn Norwegian', description:'Achieve conversational fluency in Norwegian', hours:1200, category:'Language', keywords:['norwegian','language','learn','speak','fluent'] },
        { id:'lang-portuguese', title:'Learn Portuguese', description:'Achieve conversational fluency in Portuguese', hours:1200, category:'Language', keywords:['portuguese','language','learn','speak','fluent'] },
        { id:'lang-romanian', title:'Learn Romanian', description:'Achieve conversational fluency in Romanian', hours:1200, category:'Language', keywords:['romanian','language','learn','speak','fluent'] },
        { id:'lang-spanish', title:'Learn Spanish', description:'Achieve conversational fluency in Spanish', hours:1200, category:'Language', keywords:['spanish','language','learn','speak','fluent'] },
        { id:'lang-swedish', title:'Learn Swedish', description:'Achieve conversational fluency in Swedish', hours:1200, category:'Language', keywords:['swedish','language','learn','speak','fluent'] },

        // Category II (1500 hours)
        { id:'lang-german', title:'Learn German', description:'Achieve conversational fluency in German', hours:1500, category:'Language', keywords:['german','language','learn','speak','fluent'] },

        // Category III (1800 hours)
        { id:'lang-indonesian', title:'Learn Indonesian', description:'Achieve conversational fluency in Indonesian', hours:1800, category:'Language', keywords:['indonesian','bahasa','language','learn','speak','fluent'] },
        { id:'lang-malaysian', title:'Learn Malaysian', description:'Achieve conversational fluency in Malaysian', hours:1800, category:'Language', keywords:['malaysian','malay','language','learn','speak','fluent'] },
        { id:'lang-swahili', title:'Learn Swahili', description:'Achieve conversational fluency in Swahili', hours:1800, category:'Language', keywords:['swahili','kiswahili','language','learn','speak','fluent'] },

        // Category IV (2200 hours)
        { id:'lang-albanian', title:'Learn Albanian', description:'Achieve conversational fluency in Albanian', hours:2200, category:'Language', keywords:['albanian','language','learn','speak','fluent'] },
        { id:'lang-amharic', title:'Learn Amharic', description:'Achieve conversational fluency in Amharic', hours:2200, category:'Language', keywords:['amharic','language','learn','speak','fluent'] },
        { id:'lang-armenian', title:'Learn Armenian', description:'Achieve conversational fluency in Armenian', hours:2200, category:'Language', keywords:['armenian','language','learn','speak','fluent'] },
        { id:'lang-azerbaijani', title:'Learn Azerbaijani', description:'Achieve conversational fluency in Azerbaijani', hours:2200, category:'Language', keywords:['azerbaijani','azerbaijan','language','learn','speak','fluent'] },
        { id:'lang-bengali', title:'Learn Bengali', description:'Achieve conversational fluency in Bengali', hours:2200, category:'Language', keywords:['bengali','bangla','language','learn','speak','fluent'] },
        { id:'lang-bosnian', title:'Learn Bosnian', description:'Achieve conversational fluency in Bosnian', hours:2200, category:'Language', keywords:['bosnian','language','learn','speak','fluent'] },
        { id:'lang-bulgarian', title:'Learn Bulgarian', description:'Achieve conversational fluency in Bulgarian', hours:2200, category:'Language', keywords:['bulgarian','language','learn','speak','fluent'] },
        { id:'lang-burmese', title:'Learn Burmese', description:'Achieve conversational fluency in Burmese', hours:2200, category:'Language', keywords:['burmese','myanmar','language','learn','speak','fluent'] },
        { id:'lang-croatian', title:'Learn Croatian', description:'Achieve conversational fluency in Croatian', hours:2200, category:'Language', keywords:['croatian','language','learn','speak','fluent'] },
        { id:'lang-czech', title:'Learn Czech', description:'Achieve conversational fluency in Czech', hours:2200, category:'Language', keywords:['czech','language','learn','speak','fluent'] },
        { id:'lang-estonian', title:'Learn Estonian', description:'Achieve conversational fluency in Estonian', hours:2200, category:'Language', keywords:['estonian','language','learn','speak','fluent'] },
        { id:'lang-finnish', title:'Learn Finnish', description:'Achieve conversational fluency in Finnish', hours:2200, category:'Language', keywords:['finnish','language','learn','speak','fluent'] },
        { id:'lang-georgian', title:'Learn Georgian', description:'Achieve conversational fluency in Georgian', hours:2200, category:'Language', keywords:['georgian','language','learn','speak','fluent'] },
        { id:'lang-greek', title:'Learn Greek', description:'Achieve conversational fluency in Greek', hours:2200, category:'Language', keywords:['greek','language','learn','speak','fluent'] },
        { id:'lang-hebrew', title:'Learn Hebrew', description:'Achieve conversational fluency in Hebrew', hours:2200, category:'Language', keywords:['hebrew','language','learn','speak','fluent'] },
        { id:'lang-hindi', title:'Learn Hindi', description:'Achieve conversational fluency in Hindi', hours:2200, category:'Language', keywords:['hindi','language','learn','speak','fluent'] },
        { id:'lang-hungarian', title:'Learn Hungarian', description:'Achieve conversational fluency in Hungarian', hours:2200, category:'Language', keywords:['hungarian','magyar','language','learn','speak','fluent'] },
        { id:'lang-icelandic', title:'Learn Icelandic', description:'Achieve conversational fluency in Icelandic', hours:2200, category:'Language', keywords:['icelandic','language','learn','speak','fluent'] },
        { id:'lang-khmer', title:'Learn Khmer', description:'Achieve conversational fluency in Khmer', hours:2200, category:'Language', keywords:['khmer','cambodian','language','learn','speak','fluent'] },
        { id:'lang-lao', title:'Learn Lao', description:'Achieve conversational fluency in Lao', hours:2200, category:'Language', keywords:['lao','language','learn','speak','fluent'] },
        { id:'lang-latvian', title:'Learn Latvian', description:'Achieve conversational fluency in Latvian', hours:2200, category:'Language', keywords:['latvian','language','learn','speak','fluent'] },
        { id:'lang-lithuanian', title:'Learn Lithuanian', description:'Achieve conversational fluency in Lithuanian', hours:2200, category:'Language', keywords:['lithuanian','language','learn','speak','fluent'] },
        { id:'lang-macedonian', title:'Learn Macedonian', description:'Achieve conversational fluency in Macedonian', hours:2200, category:'Language', keywords:['macedonian','language','learn','speak','fluent'] },
        { id:'lang-mongolian', title:'Learn Mongolian', description:'Achieve conversational fluency in Mongolian', hours:2200, category:'Language', keywords:['mongolian','language','learn','speak','fluent'] },
        { id:'lang-nepali', title:'Learn Nepali', description:'Achieve conversational fluency in Nepali', hours:2200, category:'Language', keywords:['nepali','language','learn','speak','fluent'] },
        { id:'lang-pashto', title:'Learn Pashto', description:'Achieve conversational fluency in Pashto', hours:2200, category:'Language', keywords:['pashto','language','learn','speak','fluent'] },
        { id:'lang-persian', title:'Learn Persian (Dari, Farsi, Tajik)', description:'Achieve conversational fluency in Persian', hours:2200, category:'Language', keywords:['persian','dari','farsi','tajik','language','learn','speak','fluent'] },
        { id:'lang-polish', title:'Learn Polish', description:'Achieve conversational fluency in Polish', hours:2200, category:'Language', keywords:['polish','language','learn','speak','fluent'] },
        { id:'lang-russian', title:'Learn Russian', description:'Achieve conversational fluency in Russian', hours:2200, category:'Language', keywords:['russian','language','learn','speak','fluent'] },
        { id:'lang-serbian', title:'Learn Serbian', description:'Achieve conversational fluency in Serbian', hours:2200, category:'Language', keywords:['serbian','language','learn','speak','fluent'] },
        { id:'lang-sinhala', title:'Learn Sinhala', description:'Achieve conversational fluency in Sinhala', hours:2200, category:'Language', keywords:['sinhala','sinhalese','language','learn','speak','fluent'] },
        { id:'lang-slovak', title:'Learn Slovak', description:'Achieve conversational fluency in Slovak', hours:2200, category:'Language', keywords:['slovak','language','learn','speak','fluent'] },
        { id:'lang-slovenian', title:'Learn Slovenian', description:'Achieve conversational fluency in Slovenian', hours:2200, category:'Language', keywords:['slovenian','language','learn','speak','fluent'] },
        { id:'lang-tagalog', title:'Learn Tagalog', description:'Achieve conversational fluency in Tagalog', hours:2200, category:'Language', keywords:['tagalog','filipino','language','learn','speak','fluent'] },
        { id:'lang-thai', title:'Learn Thai', description:'Achieve conversational fluency in Thai', hours:2200, category:'Language', keywords:['thai','language','learn','speak','fluent'] },
        { id:'lang-turkish', title:'Learn Turkish', description:'Achieve conversational fluency in Turkish', hours:2200, category:'Language', keywords:['turkish','language','learn','speak','fluent'] },
        { id:'lang-ukrainian', title:'Learn Ukrainian', description:'Achieve conversational fluency in Ukrainian', hours:2200, category:'Language', keywords:['ukrainian','language','learn','speak','fluent'] },
        { id:'lang-urdu', title:'Learn Urdu', description:'Achieve conversational fluency in Urdu', hours:2200, category:'Language', keywords:['urdu','language','learn','speak','fluent'] },
        { id:'lang-uzbek', title:'Learn Uzbek', description:'Achieve conversational fluency in Uzbek', hours:2200, category:'Language', keywords:['uzbek','language','learn','speak','fluent'] },
        { id:'lang-vietnamese', title:'Learn Vietnamese', description:'Achieve conversational fluency in Vietnamese', hours:2200, category:'Language', keywords:['vietnamese','language','learn','speak','fluent'] },
        { id:'lang-xhosa', title:'Learn Xhosa', description:'Achieve conversational fluency in Xhosa', hours:2200, category:'Language', keywords:['xhosa','language','learn','speak','fluent'] },
        { id:'lang-zulu', title:'Learn Zulu', description:'Achieve conversational fluency in Zulu', hours:2200, category:'Language', keywords:['zulu','language','learn','speak','fluent'] },

        // Category V (4400 hours)
        { id:'lang-arabic', title:'Learn Arabic', description:'Achieve conversational fluency in Arabic', hours:4400, category:'Language', keywords:['arabic','language','learn','speak','fluent'] },
        { id:'lang-cantonese', title:'Learn Cantonese (Chinese)', description:'Achieve conversational fluency in Cantonese', hours:4400, category:'Language', keywords:['cantonese','chinese','language','learn','speak','fluent'] },
        { id:'lang-mandarin', title:'Learn Mandarin (Chinese)', description:'Achieve conversational fluency in Mandarin Chinese', hours:4400, category:'Language', keywords:['mandarin','chinese','language','learn','speak','fluent'] },
        { id:'lang-japanese', title:'Learn Japanese', description:'Achieve conversational fluency in Japanese', hours:4400, category:'Language', keywords:['japanese','language','learn','speak','fluent'] },
        { id:'lang-korean', title:'Learn Korean', description:'Achieve conversational fluency in Korean', hours:4400, category:'Language', keywords:['korean','language','learn','speak','fluent'] },
        { id:'prog-react', title:'Master React Development', description:'Become proficient in React and modern frontend development', hours:200, category:'Programming', keywords:['react','javascript','frontend','web','development','programming'] },
        { id:'prog-python', title:'Learn Python Programming', description:'Master Python for data science and web development', hours:300, category:'Programming', keywords:['python','programming','data','science','web','development'] },
        { id:'prog-fullstack', title:'Full-Stack Web Development', description:'Learn complete web development stack', hours:500, category:'Programming', keywords:['fullstack','web','development','frontend','backend','programming'] },
        { id:'skill-piano', title:'Learn Piano', description:'Develop piano playing skills from beginner to intermediate', hours:500, category:'Music', keywords:['piano','music','instrument','play','learn'] },
        { id:'skill-guitar', title:'Learn Guitar', description:'Master acoustic guitar playing', hours:300, category:'Music', keywords:['guitar','music','instrument','play','learn','acoustic'] },
        { id:'skill-drawing', title:'Learn Drawing', description:'Develop artistic drawing and sketching skills', hours:200, category:'Art', keywords:['drawing','art','sketch','artistic','creative'] },
      ];

      const ag = { title: document.getElementById('ag_title'), desc: document.getElementById('ag_desc'), hours: document.getElementById('ag_hours'), sugg: document.getElementById('ag_suggestions'), submit: document.getElementById('ag_submit'), cancel: document.getElementById('ag_cancel') };
      function openAddGoalModal() {
        ag.title.value = ''; ag.desc.value = ''; ag.hours.value = '';
        ag.sugg.innerHTML = ''; ag.sugg.style.display='none';
        ag.submit.disabled = true;
        showModal(addGoalModal);
        setTimeout(()=>ag.title.focus(), 0);
      }
      function closeAddGoalModal() { hideModal(addGoalModal); }
      ag.title.addEventListener('input', () => {
        const q = ag.title.value.trim().toLowerCase();
        const matches = q.length >= 2 ? templates.filter(t => t.title.toLowerCase().includes(q) || t.keywords.some(k=>k.includes(q))) : [];
        ag.sugg.innerHTML = '';
        if (matches.length === 0) { ag.sugg.style.display='none'; } else {
          ag.sugg.style.display='block';
          for (const t of matches) {
            const item = document.createElement('div');
            item.style.padding='8px 10px'; item.style.cursor='pointer'; item.style.borderBottom='1px solid #eee';
            item.innerHTML = `<div><strong>${t.title}</strong></div><div class="small muted">${t.description}</div><div class="small muted">${t.hours} hours • ${t.category}</div>`;
            item.addEventListener('click', ()=>{ ag.title.value = t.title; ag.desc.value = t.description; ag.hours.value = String(t.hours); ag.sugg.style.display='none'; validateAddGoalForm(); });
            ag.sugg.appendChild(item);
          }
        }
        validateAddGoalForm();
      });
      function validateAddGoalForm() {
        const valid = ag.title.value.trim().length > 0 && Number(ag.hours.value) > 0;
        ag.submit.disabled = !valid;
      }
      ag.hours.addEventListener('input', validateAddGoalForm);
      ag.cancel.addEventListener('click', closeAddGoalModal);
      ag.submit.addEventListener('click', () => { addGoal(ag.title.value.trim(), Math.max(0.1, Number(ag.hours.value)), ag.desc.value.trim()); closeAddGoalModal(); });

      // Add Time Modal
      const atm = { hours: document.getElementById('atm_hours'), date: document.getElementById('atm_date'), submit: document.getElementById('atm_submit'), cancel: document.getElementById('atm_cancel'), error: document.getElementById('atm_error') };
      document.getElementById('atm_date').setAttribute('max', new Date().toISOString().split('T')[0]);
      function openAddTimeModal(goalId) { addTimeForGoalId = goalId; atm.hours.value=''; atm.date.value=''; atm.error.style.display='none'; atm.submit.disabled = true; showModal(addTimeModal); setTimeout(()=>atm.hours.focus(),0); }
      function closeAddTimeModal() { hideModal(addTimeModal); }
      atm.hours.addEventListener('input', () => { atm.submit.disabled = !(Number(atm.hours.value) > 0); });
      atm.cancel.addEventListener('click', closeAddTimeModal);
      atm.submit.addEventListener('click', () => {
        const hours = Number(atm.hours.value);
        const date = atm.date.value ? new Date(atm.date.value) : new Date();
        const all = loadSessions();
        const validation = validateDailyLimit(all, hours, date);
        if (!validation.ok) { atm.error.textContent = validation.message; atm.error.style.display='block'; return; }
        // apply as session
        const duration = hours * 3600000;
        addSession({ goalId: addTimeForGoalId, startTime: date.getTime() - duration, endTime: date.getTime(), duration });
        const g = goals.find(g=>g.id===addTimeForGoalId); if (g) { g.totalTimeSpent += duration; saveGoals(goals); }
        closeAddTimeModal(); render();
      });

      // Progress Modal with ECharts
      const pm = { stats: document.getElementById('pm_stats'), chart: document.getElementById('pm_chart'), close: document.getElementById('pm_close'), title: document.getElementById('progressTitle') };
      pm.close.addEventListener('click', () => hideModal(progressModal));
      function openProgressModal(goalId) {
        progressForGoalId = goalId;
        const goal = goals.find(g=>g.id===goalId); if (!goal) return;
        pm.title.textContent = `Progress: ${goal.title}`;
        const sessions = loadSessions().filter(s=>s.goalId===goal.id);
        const totalTime = goal.totalTimeSpent + (goal.isActive && goal.startTime ? (Date.now()-goal.startTime) : 0);
        const totalHoursSpent = totalTime/3600000;
        const remaining = Math.max(0, goal.totalHours - totalHoursSpent);
        const pct = Math.min(100, (totalHoursSpent/goal.totalHours) * 100);
        const est = estimateCompletion(goal, loadSessions());
        pm.stats.innerHTML = `<div><strong>Total time:</strong> ${formatDuration(totalTime)} (${totalHoursSpent.toFixed(1)}h / ${goal.totalHours}h)</div><div><strong>Progress:</strong> ${pct.toFixed(1)}%</div><div><strong>Remaining:</strong> ${remaining.toFixed(1)}h</div>${est ? `<div><strong>Estimated completion:</strong> ${est.toLocaleDateString()}</div>`:''}`;
        showModal(progressModal);
        setTimeout(()=>renderProgressChart(sessions, goal.title, goal.totalHours), 100);
      }
      function renderProgressChart(sessions, goalTitle, totalHours) {
        if (!pm.chart) return;
        const dailyTotals = new Map();
        sessions.forEach(s=>{ const key = new Date(s.startTime).toDateString(); const h = s.duration/3600000; dailyTotals.set(key, (dailyTotals.get(key)||0)+h); });
        const dates = Array.from(dailyTotals.keys()).sort((a,b)=> new Date(a).getTime() - new Date(b).getTime());
        let cumulative = 0; const dailyData = dates.map(d=>{ const hours = dailyTotals.get(d)||0; cumulative += hours; return { date:d, hours, cumulative }; });
        const option = {
          title: { text: `Progress: ${goalTitle}`, left: 'center', textStyle:{ fontSize:16 } },
          tooltip: { trigger:'axis', formatter: (params)=>{ const data = params[0]; return `<div><strong>${data.name}</strong><br/>Daily: ${data.value.toFixed(1)}h<br/>Cumulative: ${data.data.cumulative.toFixed(1)}h<br/>Progress: ${((data.data.cumulative/totalHours)*100).toFixed(1)}%</div>`; } },
          xAxis: { type:'category', data: dailyData.map(d=>d.date), axisLabel:{ formatter:(v)=>{ const dt=new Date(v); return `${dt.getMonth()+1}/${dt.getDate()}`; } } },
          yAxis: [ { type:'value', name:'Hours', position:'left', axisLabel:{ formatter:'{value}h' } }, { type:'value', name:'Progress %', position:'right', max:100, axisLabel:{ formatter:'{value}%' } } ],
          series: [ { name:'Daily Hours', type:'bar', data: dailyData.map(d=>({ value: d.hours, cumulative: d.cumulative })), itemStyle:{ color:'#3b82f6' } }, { name:'Cumulative Progress', type:'line', yAxisIndex:1, data: dailyData.map(d=>((d.cumulative/totalHours)*100).toFixed(1)), itemStyle:{ color:'#10b981' }, lineStyle:{ width:3 }, symbol:'circle', symbolSize:6 } ],
          grid: { right:'20%' }, legend: { data:['Daily Hours','Cumulative Progress'], bottom:10 }
        };
        const chart = echarts.init(pm.chart); chart.setOption(option); window.addEventListener('resize', ()=>chart.resize(), { once:true });
      }

      // Persist active session periodically and on unload
      document.addEventListener('visibilitychange', () => {
        const active = goals.find(g=>g.isActive);
        if (document.visibilityState === 'hidden' && active && active.startTime) {
          saveActiveSession({ goalId: active.id, startTime: active.startTime, lastUpdated: Date.now() });
        }
      });
      window.addEventListener('beforeunload', () => {
        const active = goals.find(g=>g.isActive);
        if (active && active.startTime) saveActiveSession({ goalId: active.id, startTime: active.startTime, lastUpdated: Date.now() });
      });

      // Restore active session on load
      (function restoreActive(){
        const s = getActiveSession();
        if (!s) return;
        const g = goals.find(g=>g.id===s.goalId);
        if (!g) { saveActiveSession(null); return; }
        g.isActive = true;
        g.startTime = s.startTime;
        saveGoals(goals);
      })();

      // ---- Initial render ----
      render();

      // ---- Delete Confirmation ----
      const del = { modal: deleteModal, confirm: document.getElementById('del_confirm'), cancel: document.getElementById('del_cancel'), question: document.getElementById('del_question'), warning: document.getElementById('del_warning') };
      let deleteGoalId = null;
      function openDeleteModal(goalId, title) {
        deleteGoalId = goalId;
        del.question.textContent = `Are you sure you want to delete "${title}"?`;
        showModal(del.modal);
      }
      del.cancel.addEventListener('click', () => hideModal(del.modal));
      del.confirm.addEventListener('click', () => { if (deleteGoalId) deleteGoal(deleteGoalId); deleteGoalId = null; hideModal(del.modal); });

      // ---- Analytics ----
      const an = { trend: document.getElementById('an_trend'), pie: document.getElementById('an_pie'), close: document.getElementById('an_close') };
      an.close.addEventListener('click', () => hideModal(analyticsModal));
      function openAnalytics() {
        showModal(analyticsModal);
        setTimeout(() => renderAnalytics(), 50);
      }
      function renderAnalytics() {
        const sessions = loadSessions();
        // Trend chart
        const dailyTotals = new Map();
        sessions.forEach(s => { const key = new Date(s.startTime).toDateString(); const h = s.duration/3600000; dailyTotals.set(key, (dailyTotals.get(key)||0)+h); });
        const dates = Array.from(dailyTotals.keys()).sort((a,b)=> new Date(a).getTime() - new Date(b).getTime());
        const series = dates.map(d => Number((dailyTotals.get(d)||0).toFixed(2)));
        const trend = echarts.init(an.trend);
        trend.setOption({
          title:{ text:'Daily Time Trend', left:'center', textStyle:{ fontSize:16 } },
          tooltip:{ trigger:'axis' },
          xAxis:{ type:'category', data: dates.map(d => { const dt=new Date(d); return `${dt.getMonth()+1}/${dt.getDate()}`; }) },
          yAxis:{ type:'value', name:'Hours' },
          series:[{ type:'line', data: series, smooth:true, areaStyle:{}, color:'#3b82f6' }],
          grid:{ left:48, right:16, top:48, bottom:40 }
        });
        // Pie by goal
        const byGoal = new Map();
        sessions.forEach(s => { const h=s.duration/3600000; byGoal.set(s.goalId, (byGoal.get(s.goalId)||0)+h); });
        const pieData = Array.from(byGoal.entries()).map(([goalId, hours]) => {
          const g = goals.find(g=>g.id===goalId); return { name: g ? g.title : goalId, value: Number(hours.toFixed(2)) };
        });
        const pie = echarts.init(an.pie);
        pie.setOption({
          title:{ text:'Time by Goal', left:'center', textStyle:{ fontSize:16 } },
          tooltip:{ trigger:'item' },
          series:[{ type:'pie', radius:['35%','70%'], data: pieData, emphasis:{ itemStyle:{ shadowBlur:10, shadowOffsetX:0, shadowColor:'rgba(0,0,0,0.3)' } } }]
        });
        window.addEventListener('resize', () => { trend.resize(); pie.resize(); }, { once: true });
      }

      // ---- Backup & Restore ----
      function exportBackup() {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          goals: loadGoals(),
          sessions: loadSessions(),
          activeSession: getActiveSession()
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `mastery-backup-${ts}.json`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
      }

      function importBackup(jsonText) {
        let data;
        try { data = JSON.parse(jsonText); } catch { alert('Invalid JSON backup.'); return; }
        if (!data || typeof data !== 'object') { alert('Invalid backup format.'); return; }
        const { goals: g, sessions: s, activeSession: a } = data;
        if (!Array.isArray(g) || !Array.isArray(s)) { alert('Backup missing goals or sessions arrays.'); return; }
        if (!confirm('Importing will replace your current data. Continue?')) return;
        try {
          localStorage.setItem(GOALS_KEY, JSON.stringify(g));
          localStorage.setItem(SESSIONS_KEY, JSON.stringify(s));
          if (a) localStorage.setItem(ACTIVE_SESSION_KEY, JSON.stringify(a)); else localStorage.removeItem(ACTIVE_SESSION_KEY);
          goals = loadGoals();
          render();
          alert('Backup imported successfully.');
        } catch (e) {
          alert('Failed to import backup.');
        }
      }
    </script>
  </body>
  </html>


