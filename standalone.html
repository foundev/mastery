<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mastery (Standalone)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <style>
    .goal-card { border: 1px solid var(--muted-border-color); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem; }
    .progress-bar { width: 100%; height: 10px; background: var(--muted-border-color); border-radius: 5px; overflow: hidden; margin-top: .5rem; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width .25s; }
    .controls { display: flex; gap: .5rem; flex-wrap: wrap; }
    .muted { color: var(--muted-color); font-size: .9rem; }
    .fab { position: fixed; right: 2rem; bottom: 2rem; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: #fff; border: 0; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,.15); }
    .row { display: flex; gap: 1rem; align-items: end; flex-wrap: wrap; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script>
  // Storage keys
  const GOALS_KEY = 'goal-tracker-goals';
  const SESSIONS_KEY = 'goal-tracker-sessions';
  const ACTIVE_KEY = 'goal-tracker-active-session';
  const BACKUP_VERSION = 1;

  // Helpers
  const $$ = (sel, root = document) => root.querySelector(sel);
  const $$$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const formatMs = (ms) => {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours}h ${String(minutes).padStart(2,'0')}m ${String(seconds).padStart(2,'0')}s`;
  };
  const todayYMD = () => new Date().toISOString().slice(0,10);

  // Storage API
  const storage = {
    getGoals() {
      try { return JSON.parse(localStorage.getItem(GOALS_KEY) || '[]'); } catch { return []; }
    },
    saveGoals(goals) {
      try { localStorage.setItem(GOALS_KEY, JSON.stringify(goals)); } catch {}
    },
    getSessions() {
      try { return JSON.parse(localStorage.getItem(SESSIONS_KEY) || '[]'); } catch { return []; }
    },
    saveSessions(sessions) {
      try { localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions)); } catch {}
    },
    addSession(session) {
      const sessions = storage.getSessions();
      sessions.push(session);
      storage.saveSessions(sessions);
    },
    getActive() {
      try { return JSON.parse(localStorage.getItem(ACTIVE_KEY) || 'null'); } catch { return null; }
    },
    saveActive(active) {
      try {
        if (active) localStorage.setItem(ACTIVE_KEY, JSON.stringify(active)); else localStorage.removeItem(ACTIVE_KEY);
      } catch {}
    },
    exportAll() {
      return JSON.stringify({
        version: BACKUP_VERSION,
        exportedAt: Date.now(),
        goals: storage.getGoals(),
        sessions: storage.getSessions(),
        activeSession: storage.getActive(),
      });
    },
    importAll(json) {
      let data; try { data = JSON.parse(json); } catch { return { ok:false, error:'Invalid JSON' }; }
      if (!data || typeof data !== 'object') return { ok:false, error:'Invalid backup format' };
      if (typeof data.version !== 'number') return { ok:false, error:'Missing version' };
      if (Math.floor(data.version) > Math.floor(BACKUP_VERSION)) return { ok:false, error:'Backup from newer version' };
      if (!Array.isArray(data.goals) || !Array.isArray(data.sessions)) return { ok:false, error:'Missing goals/sessions' };
      if (!(data.activeSession === null || (data.activeSession && typeof data.activeSession.goalId === 'string' && Number.isFinite(data.activeSession.startTime)))) return { ok:false, error:'Invalid active session' };
      storage.saveGoals(data.goals);
      storage.saveSessions(data.sessions);
      storage.saveActive(data.activeSession || null);
      return { ok:true };
    }
  };

  // App state (in-memory while page is open)
  let goals = storage.getGoals(); // [{id,title,description,targetHours}]
  let sessions = storage.getSessions(); // [{goalId,start,end}]
  let active = storage.getActive(); // {goalId,startTime,lastUpdated}

  const genId = () => Math.random().toString(36).slice(2, 10);
  const goalTotalMs = (goalId) => sessions.filter(s=>s.goalId===goalId).reduce((a,s)=>a+(s.end-s.start),0) + (active && active.goalId===goalId ? (Date.now()-active.startTime) : 0);
  const goalPercent = (goalId, targetHours) => Math.min(100, Math.floor((goalTotalMs(goalId)/(targetHours*3600000))*100));

  function saveState() {
    storage.saveGoals(goals);
    storage.saveSessions(sessions);
    storage.saveActive(active);
  }

  // Actions
  function addGoal({ title, description, targetHours }) {
    const g = { id: genId(), title, description, targetHours: Number(targetHours) };
    goals.push(g); saveState(); render();
  }
  function deleteGoal(goalId) {
    if (!confirm('Delete this goal and all its sessions?')) return;
    if (active && active.goalId===goalId) active = null;
    goals = goals.filter(g=>g.id!==goalId);
    sessions = sessions.filter(s=>s.goalId!==goalId);
    saveState(); render();
  }
  function startTimer(goalId) {
    if (active && active.goalId!==goalId) {
      if (!confirm('Another timer is running. Stop it and start this one?')) return;
      stopTimer();
    }
    if (!active) {
      active = { goalId, startTime: Date.now(), lastUpdated: Date.now() };
      saveState(); renderTicker();
    }
  }
  function stopTimer() {
    if (!active) return;
    const { goalId, startTime } = active;
    const now = Date.now();
    if (now > startTime) sessions.push({ goalId, start: startTime, end: now, date: todayYMD() });
    active = null; saveState(); render();
  }
  function addManualTime(goalId) {
    const minutes = Number(prompt('Minutes to add (max 1440 across all goals for a day):', '30'));
    if (!Number.isFinite(minutes) || minutes <= 0) return alert('Invalid minutes');
    const date = prompt('Date (YYYY-MM-DD):', todayYMD());
    if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) return alert('Invalid date');
    const ms = minutes * 60000; const now = Date.now();
    sessions.push({ goalId, start: now - ms, end: now, date });
    saveState(); render();
  }

  // Backup/Restore
  function exportJSON() {
    const data = storage.exportAll();
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `mastery-backup-${todayYMD()}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  }
  async function importJSON(file) {
    if (!file) return;
    if (!confirm('Importing will replace your current data. Continue?')) return;
    const text = await file.text();
    const res = storage.importAll(text);
    if (!res.ok) return alert(res.error);
    alert('Import successful. Reloading...');
    location.reload();
  }

  // Rendering
  function renderHeader() {
    $$('#exportBtn').onclick = exportJSON;
    $$('#importBtn').onclick = () => $$('#importInput').click();
    $$('#importInput').onchange = (e) => importJSON(e.target.files[0]);
  }

  function renderAddForm() {
    const form = $$('#addGoalForm');
    form.onsubmit = (e) => {
      e.preventDefault();
      const title = form.title.value.trim();
      const description = form.description.value.trim();
      const targetHours = Number(form.targetHours.value);
      if (!title || !Number.isFinite(targetHours) || targetHours <= 0) return alert('Please enter valid fields');
      addGoal({ title, description, targetHours });
      form.reset();
    };
  }

  function renderGoalRow(goal) {
    const totalMs = goalTotalMs(goal.id);
    const pct = goalPercent(goal.id, goal.targetHours);
    const div = document.createElement('article');
    div.className = 'goal-card';
    div.innerHTML = `
      <header>
        <strong>${goal.title}</strong>
      </header>
      <p class="muted">${goal.description ? goal.description : ''}</p>
      <div class="muted">Spent: ${formatMs(totalMs)} / Target: ${goal.targetHours}h</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="controls">
        <button data-action="start">${active && active.goalId===goal.id ? 'Running' : 'Start'}</button>
        <button data-action="stop" class="secondary">Stop</button>
        <button data-action="add" class="secondary">Add Time</button>
        <button data-action="progress" class="secondary">Show Progress</button>
        <button data-action="delete" class="contrast">Delete</button>
      </div>
    `;

    $$$('button', div).forEach(btn => {
      btn.onclick = () => {
        const action = btn.getAttribute('data-action');
        if (action==='start') startTimer(goal.id);
        if (action==='stop') stopTimer();
        if (action==='add') addManualTime(goal.id);
        if (action==='delete') deleteGoal(goal.id);
        if (action==='progress') showProgress(goal.id);
      };
    });
    return div;
  }

  function showProgress(goalId) {
    const goal = goals.find(g=>g.id===goalId);
    if (!goal) return;
    const modal = $$('#progressModal');
    $$('#progressTitle').textContent = `${goal.title} â€” Progress`;
    modal.setAttribute('open', '');
    // Prepare daily totals
    const series = {};
    sessions.filter(s=>s.goalId===goalId).forEach(s=>{
      const day = s.date || new Date(s.end).toISOString().slice(0,10);
      series[day] = (series[day]||0) + (s.end - s.start)/3600000;
    });
    const days = Object.keys(series).sort();
    const values = days.map(d=>Number(series[d].toFixed(2)));
    const el = $$('#chart');
    const chart = echarts.init(el);
    chart.setOption({
      tooltip: {},
      xAxis: { type: 'category', data: days },
      yAxis: { type: 'value', name: 'hours' },
      series: [{ type:'bar', data: values }]
    });
    $$('#closeProgress').onclick = () => { chart.dispose(); modal.removeAttribute('open'); };
  }

  function renderList() {
    const container = $$('#goalList');
    container.innerHTML = '';
    goals.forEach(g=> container.appendChild(renderGoalRow(g)));
  }

  function renderTicker() {
    // Update running goal cards time readouts each second
    if (!renderTicker._interval) {
      renderTicker._interval = setInterval(()=>{ if (active) renderList(); }, 1000);
    }
  }

  function render() {
    renderList();
  }

  window.addEventListener('DOMContentLoaded', () => {
    renderHeader();
    renderAddForm();
    render();
    if (active) renderTicker();
  });
  </script>
</head>
<body>
  <main class="container">
    <hgroup>
      <h1>Goal Tracker</h1>
      <h2>Track time spent working towards your goals</h2>
    </hgroup>

    <div class="row" style="margin-bottom:1rem">
      <button id="exportBtn" class="secondary">Export JSON</button>
      <button id="importBtn" class="secondary">Import JSON</button>
      <input id="importInput" type="file" accept="application/json,.json" style="display:none" />
    </div>

    <article>
      <h3>Add Goal</h3>
      <form id="addGoalForm">
        <div class="grid">
          <input name="title" placeholder="Title" required />
          <input name="description" placeholder="Description (optional)" />
          <input name="targetHours" type="number" min="1" step="1" placeholder="Target hours" required />
        </div>
        <button type="submit">Add Goal</button>
      </form>
    </article>

    <section id="goalList" style="margin-top:1rem"></section>

    <dialog id="progressModal" class="progress-modal">
      <article>
        <header style="display:flex;justify-content:space-between;align-items:center">
          <strong id="progressTitle">Progress</strong>
          <button id="closeProgress" class="secondary">Close</button>
        </header>
        <div id="chart" style="width:100%;height:320px"></div>
      </article>
    </dialog>

    <button class="fab" title="Add Goal" onclick="document.getElementById('addGoalForm').scrollIntoView({behavior:'smooth'});">+</button>
  </main>
</body>
</html>


